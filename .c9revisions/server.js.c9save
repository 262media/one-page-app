{"ts":1354286768461,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var port = process.env.PORT || 4000,\n    app = require('./app').init(port),\n\tdirty = require('dirty');\n\t\nvar locals = {\n\tauthor:'in1'\n\t// add other vars here\n};\n\nvar userDb = dirty('user.db');\n\napp.get('/', function(req,res){\n    locals.date = new Date().toLocaleDateString();\n\t\n\tvar appDb = dirty('app.db'),\n\t\tsectionsDb;\n\t\n\tappDb.on('load', function() {\n\t\tsectionsDb = dirty('sections.db');\n\t\tsectionsDb.on('load', function() {\n\t\t\t/*\n\t\t\tsectionsDb.forEach(function(key, val) {\n\t\t\t\tconsole.log('Found key: %s, val: %j', key, val);\n\t\t\t});\n\t\t\t*/\n\t\t\tres.render('index.ejs', {locals:locals,sections:sectionsDb,app:appDb.get('app'),page:appDb.get('page')});\n\t\t});\n\t});\n});\n\napp.get('/login', function(req,res){\n\tvar appDb = dirty('app.db'),\n\t\tsectionsDb;\n\t\n\tappDb.on('load', function() {\n\t\tsectionsDb = dirty('sections.db');\n\t\tsectionsDb.on('load', function() {\n\t\tres.render('login', {locals:locals,sections:sectionsDb,app:appDb.get('app'),page:appDb.get('page')});\n\t\t});\n\t});\n\n});\n\napp.post('/login', function(req,res){\n\n\tconsole.log(\"logging in\");\n\treq.session.loggedIn=true;\n\tres.redirect('/admin');\n\n});\n\napp.get('/logout', function(req,res){\n\n\tconsole.log(\"logging out\");\n\tdelete req.session.loggedIn;\n\tres.redirect('/');\n\n});\n\napp.get('/admin', function(req,res){\n    locals.date = new Date().toLocaleDateString();\n\t\n\t//console.log(\"cookies:\"+JSON.stringify(req.cookies));\n\t//console.log(\"session:\"+JSON.stringify(req.session));\n\t\n\tif (req.session.loggedIn) {\n\t\tvar appDb = dirty('app.db');\n\t\tappDb.on('load', function() {\n\t\t\tsectionsDb = dirty('sections.db');\n\t\t\tsectionsDb.on('load', function() {\n\t\t\t\t/*\n\t\t\t\tsectionsDb.forEach(function(key, val) {\n\t\t\t\t\tconsole.log('Found key: %s, val: %j', key, val);\n\t\t\t\t});\n\t\t\t\t*/\n\t\t\t\ttemplatesDb = dirty('templates.db');\n\t\t\t\ttemplatesDb.on('load', function() {\n\t\t\t\t\tres.render('admin', {locals:locals,sections:sectionsDb,templates:templatesDb,app:appDb.get('app'),page:appDb.get('page'),msg:req.param[\"msg\"]});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t\t\n\t}\n\telse {\n\t\t//res.render('login');\n\t\tres.redirect('/login');\n\t}\n});\n\napp.post('/admin/app', function(req,res){\n\tappDb = dirty('app.db');\n\tconsole.log('save app.');\n\t\n\tappDb.on('load', function() {\n\t\tconsole.log('save app----');\n\t\t//appDb.set('app',{title:req.body[\"title\"],description:req.body[\"description\"],keywords:req.body[\"keywords\"]}, function() {\n\t\tappDb.set('app',req.body, function() {\n\t\t\tconsole.log('Added mobile %s.', appDb.get('app'));\n\t\t});\n\t});\n\t\n\tappDb.on('drain', function() {\n\t\tconsole.log('app is saved on disk.');\n\t\t\n\t\tsectionsDb = dirty('sections.db');\n\t\tsectionsDb.on('load', function() {\n\t\t\t/*\n\t\t\tsectionsDb.forEach(function(key, val) {\n\t\t\t\tconsole.log('Found key: %s, val: %j', key, val);\n\t\t\t});\n\t\t\t*/\n\t\t\ttemplatesDb = dirty('templates.db');\n\t\t\ttemplatesDb.on('load', function() {\n\t\t\t\tres.render('admin', {locals:locals,sections:sectionsDb,templates:templatesDb,app:appDb.get('app'),page:appDb.get('page'),msg:\"App Settings Saved.\"});\n\t\t\t});\n\t\t});\n\t\n\t\t//res.redirect(\"/admin\");\n\t});\n});\n\napp.post('/admin/page', function(req,res){\n\tappDb = dirty('app.db');\n\tconsole.log('save page.');\n\t\n\tappDb.on('load', function() {\n\t\tconsole.log('save page----');\n\t\tappDb.set('page',req.body, function() {\n\t\t\tconsole.log('Saved page %s.', appDb.get('app'));\n\t\t});\n\t});\n\t\n\tappDb.on('drain', function() {\n\t\tconsole.log('app page is saved on disk.');\n\t\tres.redirect(\"/admin\");\n\t});\n});\n\napp.post('/admin/sections', function(req,res){\n\tvar sectionsDb = dirty('sections.db'),\n\t\tkey = req.body[\"section\"],\n\t\tvals = req.body;\n\t\n\tconsole.log(\"create section\");\n\t\n\tsectionsDb.on('load', function() {\n\t\tsectionsDb.set(key,vals, function() {\n\t\t\tconsole.log('Added content %s', sectionsDb.get(key));\n\t\t\tres.redirect(\"/admin#form\"+key);\n\t\t\t/*\n\t\t\tappDb = dirty('app.db');\n\t\t\tappDb.on('load', function() {\n\t\t\t\ttemplatesDb = dirty('templates.db');\n\t\t\t\ttemplatesDb.on('load', function() {\n\t\t\t\t\tres.render('admin', {locals:locals,sections:sectionsDb,templates:templatesDb,app:appDb.get('app'),page:appDb.get('page'),msg:\"Section '\"+ key + \"' created.\"});\n\t\t\t\t});\n\t\t\t});\n\t\t\t*/\n\t\t});\n\t});\n});\n\napp.post('/admin/sections/:k', function(req,res){\n\tvar appDb = dirty('app.db'),\n\t\tsectionsDb = dirty('sections.db'),\n\t\tkey = req.params[\"k\"],\n\t\t//section = req.body[\"section\"],\n\t\t//content = req.body[\"content\"];\n\t\tvals = req.body;\n\t\n\tconsole.log(\"saving section:\"+key);\n\t\n\tif (typeof key!=\"undefined\") {\n\t\tsectionsDb.on('load', function() {\n\t\t\tsectionsDb.set(key,vals, function() {\n\t\t\t\tconsole.log('Added content', sectionsDb.get(key));\n\t\t\t});\n\t\t\t//res.redirect(\"/admin\");\n\t\t\tres.send('Section saved.');\n\t\t});\n\t}\n\telse {\n\t\tres.send('Section not saved.');\n\t}\n\t\n});\n\napp.del('/admin/sections/:k', function(req,res){\n\tvar appDb = dirty('app.db'),\n\t\tsectionsDb = dirty('sections.db'),\n\t\tkey = req.params[\"k\"],\n\t\tsection = req.body[\"section\"];\n\t\n\tif (typeof key!=\"undefined\") {\n\t\tsectionsDb.rm(key, function() {\n\t\t\tconsole.log('Deleted section');\n\t\t});\n\t\t\n\t\tsectionsDb.on('drain', function() {\n\t\t\t/*\n\t\t\tappDb.on('load', function() {\n\t\t\t\ttemplatesDb = dirty('templates.db');\n\t\t\t\ttemplatesDb.on('load', function() {\n\t\t\t\t\tres.render('admin', {locals:locals,sections:sectionsDb,templates:templatesDb,app:appDb.get('app'),page:appDb.get('page'),msg:\"Section '\"+ key + \"' deleted.\"});\n\t\t\t\t});\n\t\t\t});\n\t\t\t*/\n\t\t\tres.send('Section deleted.');\n\t\t});\n\t}\n\telse {\n\t\tres.send('Section delete failed.')\n\t}\n})\n\napp.post('/admin/sections/all', function(req,res){\n\tvar appDb = dirty('app.db'),\n\t\tsectionsDb = dirty('sections.db'),\n\t\tsections = req.body[\"section\"],\n\t\tcontents = req.body[\"content\"];\n\t\n\t//console.log(sections.toString());\n\t//console.log(contents.toString());\n\t\n\tvar i=0;\n\tsections.forEach(function() {\n\t\tsectionsDb.set(sections[i],{content:contents[i]}, function() {\n\t\t\tconsole.log('Added content %s.', sectionsDb.get(sections[i]));\n\t\t});\n\t\ti++;\n\t});\n\t\n\tres.render('admin', {locals:locals,app:appDb,sections:sectionsDb,msg:\"Saved Sections\"});\n});\n\napp.post('/admin/sections', function(req,res){\n\tvar appDb = dirty('app.db'),\n\t\tsectionsDb = dirty('sections.db'),\n\t\tsection = req.body[\"section\"],\n\t\tcontent = req.body[\"content\"];\n\t\n\tif (typeof section!=\"undefined\") {\n\t\tsectionsDb.set(section,{content:content}, function() {\n\t\t\tconsole.log('Added content', sectionsDb.get(section));\n\t\t\tres.redirect('/admin');\n\t\t});\n\t}\n\telse {\n\t\tres.redirect('/error');\n\t}\n\n});\n\napp.get('/admin/templates/:k', function(req,res){\n\tlocals.date = new Date().toLocaleDateString();\n\n\tvar appDb = dirty('app.db'),\n\t\tkey = req.params[\"k\"];\n\t\t\n\tlocals.id = key;\n\t\n\tif (typeof key!=\"undefined\") {\n\t\tappDb.on('load', function() {\n\t\t\tsectionsDb = dirty('sections.db');\n\t\t\tsectionsDb.on('load', function() {\n\t\t\t\ttemplatesDb = dirty('templates.db');\n\t\t\t\ttemplatesDb.on('load', function() {\n\t\t\t\t\tres.render(\"admin\",{locals:locals,templates:templatesDb,sections:sectionsDb,app:appDb.get('app'),page:appDb.get('page'),template:templatesDb.get(key)});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\telse {\n\t\tres.render('error');\n\t}\n\t\n});\n\napp.post('/admin/templates/:k', function(req,res){\n\tvar appDb = dirty('app.db'),\n\t\ttemplatesDb = dirty('templates.db'),\n\t\tkey = req.params[\"k\"],\n\t\tvals = req.body;\n\t\n\tconsole.log(\"saving\");\n\t\n\tif (typeof key!=\"undefined\") {\n\t\ttemplatesDb.on('load', function() {\n\t\t\ttemplatesDb.set(key,vals, function() {\n\t\t\t\tconsole.log('Template saved', templatesDb.get(key));\n\t\t\t});\n\t\t\t//res.redirect(\"/admin\");\n\t\t\tres.send('Thank you.');\n\t\t});\n\t}\n\telse {\n\t\tres.render('error');\n\t}\n});\n\napp.del('/admin/templates/:k', function(req,res){\n\tconsole.log(\"deleting template\");\n\t\n\tvar appDb = dirty('app.db'),\n\t\ttemplatesDb = dirty('templates.db'),\n\t\tkey = req.params[\"k\"];\n\t\n\tif (typeof key!=\"undefined\") {\n\t\ttemplatesDb.rm(key, function() {\n\t\t\tconsole.log('Deleted template');\n\t\t});\n\t}\n\t\n\ttemplatesDb.on('drain', function() {\n\t\tres.redirect('/admin');\n\t});\n})\n\napp.post('/contact', function(req,res){\n\tappDb = dirty('app.db');\n\tconsole.log('contact form submit.');\n\t\n\tappDb.on('load', function() {\n\t\tconsole.log('Form submitted.');\n\t\tres.send('Thank you.');\n\t});\n});\n\n/* The 404 Route (ALWAYS Keep this as the last route) */\napp.get('/*', function(req, res){\n    res.render('404.ejs', locals);\n});"]],"start1":0,"start2":0,"length1":0,"length2":8112}]],"length":8112}
{"contributors":[],"silentsave":false,"ts":1354287048844,"patch":[[{"diffs":[[0,"or:'in1'"],[1,",\n    _layoutFile: true"],[0,"\n\t// add"]],"start1":125,"start2":125,"length1":16,"length2":39}]],"length":8135,"saved":false}
{"ts":1354287200877,"patch":[[{"diffs":[[0,"le: true"],[1,",\n    layout:'layout'"],[0,"\n\t// add"]],"start1":148,"start2":148,"length1":16,"length2":37}]],"length":8156,"saved":false}
